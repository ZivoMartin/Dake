use std::{
    fmt::{Display, Formatter},
    net::SocketAddr,
    path::PathBuf,
    str::FromStr,
};

use anyhow::{Error, Result};
use derive_getters::Getters;

#[derive(Debug, Getters, Clone, Eq, PartialEq)]
pub struct TargetLabel {
    sock: SocketAddr,
    path: Option<PathBuf>,
}

impl Display for TargetLabel {
    fn fmt(&self, f: &mut Formatter<'_>) -> std::fmt::Result {
        match &self.path {
            Some(p) => write!(f, "{}{}", self.sock, p.display()),
            None => write!(f, "{}", self.sock),
        }
    }
}

impl FromStr for TargetLabel {
    type Err = Error;

    fn from_str(s: &str) -> Result<Self> {
        Ok(match s.split_once("|") {
            Some((socket, path)) => TargetLabel {
                sock: socket.parse()?,
                path: Some(path.parse()?),
            },
            _ => TargetLabel {
                sock: s.parse()?,
                path: None,
            },
        })
    }
}
